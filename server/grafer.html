<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="shortcut icon" type="image/x-icon" href="img/logo.png">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>GreenSense</title>
</head>

<body>
    <header id="main-header">
        <nav class="navbar-dark bg-dark" style="color: white;">
            <div class="row m-0 p-0">
                <div class="col-sm-2" style="text-align: left;"><a href="/"><img src="img/logo.png"
                            style="width: 50px;"></a></div>
                <div class="col-sm-8" style="text-align: center;">
                    <h1><a href="/">GreenSense</a></h1>
                </div>
                <div class="col-sm-2 mt-3" style="text-align: right;">
                    <h6>Velkommen bruger</h6>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="card mt-5" style="text-align: center;">
                <div class="card-header">
                    <h2>Tilse din plante</h2>
                </div>
                <div class="card-body" style="text-align: left;">
                    <div class="row">
                        <div class="col-sm-3">
                            <p>Fugtighed i jorden:<span id="jordFugtighed"> </span>%</p>
                            <p>Vandstand:<span id="vandstand"> </span>%</p>
                            <p>Fugtighed i luften:<span id="luftFugtighed"> </span>%</p>
                            <p>Temperaturen:<span id="temperatur"> </span>&deg;C</p>
                            <p>Lys m√¶ngde:<span id="lys"></span>%</p>
                        </div>
                        <div class="col-sm-9">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <canvas onclick="clickOnCanvas(this);" id="canvasTemperatur"
                                                style="width:100%;"></canvas>
                                        </div>
                                        <div class="col-sm-4">
                                            <canvas onclick="clickOnCanvas(this);" id="canvasLys"
                                                style="width:100%;"></canvas>
                                        </div>

                                        <div class="col-sm-4">
                                            <canvas onclick="clickOnCanvas(this);" id="canvasLuft"
                                                style="width:100%;"></canvas>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <canvas onclick="clickOnCanvas(this);" id="canvasJord"
                                                style="width:100%;"></canvas>
                                        </div>
                                        <div class="col-sm-4">
                                            <canvas onclick="clickOnCanvas(this);" id="canvasVand"
                                                style="background-color:orange; width:100%;"></canvas>
                                        </div>

                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="container">
                                        <div id="canvasHolder">
                                            <canvas id="myChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Optional JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>


    <script>

        function insertDataHTML(data) {
            document.getElementById("temperatur").innerHTML = " " + data[0][data[0].length - 1]
            document.getElementById("luftFugtighed").innerHTML = " " + data[1][data[1].length - 1]
            document.getElementById("lys").innerHTML = " " + data[2][data[2].length - 1]
        }


        function addData(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.push(data);
            });
            chart.update();
        }

        class ourChart {
            constructor(id, label, rgb) {
                this.id = id;
                this.label = label;
                this.ctx = document.getElementById(id).getContext('2d');
                this.chart = new Chart(this.ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            // backgroundColor: 'rgb(255, 99, 132)',
                            fill: false,
                            borderColor: rgb,
                            data: []
                        }]
                    },

                    // Configuration options go here
                    options: {

                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }],
                            xAxes: [{
                                type: 'time',
                                distribution: 'linear',
                                time: {
                                    displayFormats: {
                                        minute: 'HH:mm',
                                    },
                                    unit: 'minute',
                                }
                            }],



                        },
                        elements: {
                            point: {
                                radius: 0
                            }
                        }
                    },
                });
            }

            fillWithData(labels, data) {
                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = data;
                this.chart.update();
            }
        }

        function createChart(datapoints, labels) {

            temperaturChart = new ourChart("canvasTemperatur", 'Temperatur', 'rgb(255, 20, 20)');
            temperaturChart.fillWithData(labels, datapoints[0]);

            fugtighedsChart = new ourChart("canvasLuft", 'Fugtighed', 'rgb(20, 20, 255)');
            fugtighedsChart.fillWithData(labels, datapoints[1]);

            lysChart = new ourChart('canvasLys', 'Lysniveau', 'rgb(220, 220, 20)');
            lysChart.fillWithData(labels, datapoints[2]);


            combinedChart = new combinedCharts("myChart", [], [], [])

            charts = [temperaturChart, fugtighedsChart, lysChart];

        }

        function clickOnCanvas(can) {
            var add = true;
            for (let i = 0; i < charts.length; i++) {
                if (charts[i].id == can.id) {
                    for (let x = 0; x < combinedChart.addedCharts.length; x++) {
                        if (charts[i].id == combinedChart.addedCharts[x]) {
                            add = false;
                            // remove dataset
                            let index = combinedChart.datasets.indexOf(charts[i].chart.data.datasets[0].data);
                            if (index !== -1) combinedChart.datasets.splice(index, 1);

                            index = combinedChart.addedCharts.indexOf(charts[i].label);
                            if (index !== -1) combinedChart.labels.splice(index, 1);
                            
                            index = combinedChart.colors.indexOf(charts[i].chart.data.datasets[0].borderColor);
                            if (index !== -1) combinedChart.colors.splice(index, 1);


                            index = combinedChart.addedCharts.indexOf(charts[i].id);
                            if (index !== -1) combinedChart.addedCharts.splice(index, 1);


                            break;
                        }
                    }
                    if (add) {
                        // add dataset to combinedchart
                        combinedChart.datasets.push(charts[i].chart.data.datasets[0].data);
                        combinedChart.labels.push(charts[i].label);
                        combinedChart.colors.push(charts[i].chart.data.datasets[0].borderColor);
                        combinedChart.addedCharts.push(charts[i].id);

                    }


                    break;
                }

            }
            console.log(combinedChart);

            // set shittet ind
            combinedChart.addDataset();

            combinedChart.chart.update();

        }

        class combinedCharts {
            constructor(id, labels, datasets, colors) {
                this.id = id;
                this.labels = labels;
                this.datasets = datasets;
                this.addedCharts = [];
                this.colors = colors;
                this.ctx = document.getElementById(id).getContext('2d');
                this.chart = new Chart(this.ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: [],

                    // Configuration options go here
                    options: {

                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }],
                            xAxes: [{
                                type: 'time',
                                distribution: 'linear',
                                time: {
                                    displayFormats: {
                                        minute: 'HH:mm',
                                    },
                                    unit: 'minute',
                                }
                            }],



                        },
                        elements: {
                            point: {
                                radius: 0,
                            }
                        }
                    }
                });
            }

            addDataset() {
                this.chart.data.datasets = [];
                for (let i = 0; i < this.datasets.length; i++) {
                    this.chart.data.datasets.push({
                        label: this.labels[i],
                        borderColor: this.colors[i],
                        data: this.datasets[i],
                    });


                }
                this.chart.update();
            }

        }

        // get data from server
        let myLabels = [];
        let datapoints = [[], [], []];

        fetch(window.location.origin + '/database')
            .then((response) => {
                return response.json();

            })
            .then((database) => {
                // make response to json
                jsonData = JSON.parse(database);
                // sort data from json
                for (let element of jsonData) {
                    // get timestamp from json
                    let timestamp = element['Timestamp'];
                    timestamp = moment.unix(timestamp);
                    myLabels.push(timestamp);

                    let temperature = element['Temperature'];
                    let fugtighed = element['Humidity'];
                    let lys = element['Lightsensitivity'];

                    datapoints[0].push(temperature);
                    datapoints[1].push(fugtighed);
                    datapoints[2].push(Math.round((lys / 1023) * 100));
                }

                insertDataHTML(datapoints);
                createChart(datapoints, myLabels);

                combinedChart.chart.data.labels = myLabels;

            });



    </script>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</body>

</html>